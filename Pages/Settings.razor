@page "/settings"
@using BlazorDashboard.Services
@using BlazorDashboard.Models
@inject AppState State
@inject DataService Data
@implements IDisposable

<Navbar Title="Settings" />

<div class="settings-grid">
    <!-- 1. Settings Navigation Sidebar -->
    <GlassCard class="settings-nav-card">
        <ul class="settings-nav">
            <li class="settings-nav-item">
                <button class="settings-nav-link @(activeTab == "profile" ? "active" : "")" @onclick='() => activeTab = "profile"'>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                    Profile
                </button>
            </li>
            <li class="settings-nav-item">
                <button class="settings-nav-link @(activeTab == "security" ? "active" : "")" @onclick='() => activeTab = "security"'>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                    Security
                </button>
            </li>
            <li class="settings-nav-item">
                <button class="settings-nav-link @(activeTab == "appearance" ? "active" : "")" @onclick='() => activeTab = "appearance"'>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="M4.93 4.93l1.41 1.41"/><path d="M17.66 17.66l1.41 1.41"/></svg>
                    Appearance
                </button>
            </li>
            <li class="settings-nav-item">
                <button class="settings-nav-link @(activeTab == "billing" ? "active" : "")" @onclick='() => activeTab = "billing"'>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:20px"><rect x="1" y="4" width="22" height="16" rx="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg>
                    Billing
                </button>
            </li>
        </ul>
    </GlassCard>

    <!-- 2. Settings Content Area -->
    <GlassCard>
        @if (activeTab == "profile")
        {
            <div class="settings-tab-content active">
                <div class="profile-header">
                    <div class="profile-avatar-large">TM</div>
                    <div class="profile-info">
                        <h2>TemplateMo</h2>
                        <p>admin@templatemo.com • Administrator</p>
                    </div>
                </div>

                <div class="settings-section">
                    <h3 class="settings-section-title">Profile Information</h3>
                    <div class="form-grid">
                        <div class="form-group-settings">
                            <label>First Name</label>
                            <input type="text" class="form-input" value="Template">
                        </div>
                        <div class="form-group-settings">
                            <label>Last Name</label>
                            <input type="text" class="form-input" value="Mo">
                        </div>
                        <div class="form-group-settings full-width">
                            <label>Bio</label>
                            <textarea class="form-input">Dashboard template creator and C# enthusiast.</textarea>
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary">Save Changes</button>
            </div>
        }
        else if (activeTab == "appearance")
        {
            <div class="settings-tab-content active">
                <h3 class="settings-section-title">Appearance</h3>
                <div class="settings-row">
                    <div class="settings-label">
                        <span class="settings-label-title">Color Mode</span>
                        <span class="settings-label-desc">Switch between light and dark themes</span>
                    </div>
                    @* Use @onchange instead of @bind to ensure immediate logic execution *@
                    <select class="settings-select" value="@State.Theme" @onchange="OnThemeChanged">
                        <option value="dark">Dark Mode</option>
                        <option value="light">Light Mode</option>
                    </select>
                </div>
                <div class="settings-row">
                    <div class="settings-label">
                        <span class="settings-label-title">Glass Blur Effects</span>
                        <span class="settings-label-desc">Enable background blur on cards</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>
        }
        else if (activeTab == "billing")
        {
            <div class="settings-tab-content active">
                <div class="billing-plan-card" style="background: linear-gradient(135deg, rgba(5, 150, 105, 0.1), rgba(212, 165, 116, 0.1)); border: 1px solid var(--glass-border); padding: 24px; border-radius: 16px; margin-bottom: 30px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="font-size: 20px; font-weight: 600; margin-bottom: 4px;">Pro Plan</h4>
                            <p style="color: var(--text-muted); font-size: 14px;">Your next billing date is @GetNextBillingDate()</p>
                        </div>
                        <div style="text-align: right;">
                            <span style="font-size: 32px; font-weight: 700; font-family: 'Space Mono', monospace;">$29</span>
                            <span style="color: var(--text-muted); font-size: 14px;">/mo</span>
                        </div>
                    </div>
                </div>

                <h3 class="settings-section-title">Billing History (Live + Mock)</h3>
                <div class="table-wrapper" style="margin: 0;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Invoice</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var invoice in Data.BillingHistory)
                            {
                                <tr @key="invoice.Id?.ToString()">
                                    <td>@invoice.Date</td>
                                    <td>@invoice.Desc</td>
                                    <td><span class="table-amount">$@invoice.Amount.ToString("F2")</span></td>
                                    <td>
                                        <span class="status-badge @(invoice.Status.ToLower() == "paid" ? "completed" : "pending")">
                                            @invoice.Status
                                        </span>
                                    </td>
                                    <td><a href="#" class="invoice-download">PDF</a></td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
        else
        {
            <div class="settings-tab-content active">
                <h3 class="settings-section-title">@activeTab.ToUpper()</h3>
                <p>Management for @activeTab coming soon...</p>
            </div>
        }
    </GlassCard>
</div>

<style>
    .settings-grid {
        display: grid;
        grid-template-columns: 250px 1fr;
        gap: 24px;
    }

    .settings-nav-link {
        width: 100%;
        background: none;
        border: none;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 14px 18px;
        color: var(--text-secondary);
        border-radius: 12px;
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .settings-nav-link:hover, .settings-nav-link.active {
        background: var(--glass-hover);
        color: var(--text-primary);
    }

    .invoice-download {
        color: var(--emerald-light);
        text-decoration: none;
    }

    @@media (max-width: 992px) {
        .settings-grid { grid-template-columns: 1fr; }
    }
</style>

@code {
    private string activeTab = "profile";

    protected override async Task OnInitializedAsync()
    {
        State.OnChange += StateHasChanged;
        // Fetch DB records for the billing tab
        await Data.FetchBillingHistory();
    }

    private void OnThemeChanged(ChangeEventArgs e)
    {
        if (State.Theme != e.Value?.ToString())
        {
            State.ToggleTheme();
        }
    }

    private string GetNextBillingDate()
    {
        var now = DateTime.Now;
        var nextMonth = new DateTime(now.Year, now.Month, 1).AddMonths(1);
        return nextMonth.ToString("MMM d, yyyy");
    }

    public void Dispose() => State.OnChange -= StateHasChanged;
}